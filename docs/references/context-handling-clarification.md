# コンテキスト処理方式の明確化

## 作成日時
2025-08-26

## 目的
Claude Code 3層アーキテクチャにおけるコンテキスト処理について、「構造化JSONコンテキスト」と「Claude Codeの自然なコンテキスト機能」の区別を明確化する。

## 重要な区別

### 1. Claude Codeの「自然なコンテキスト」機能
- **定義**: エージェントが持つ会話履歴・実行状態の記憶機能
- **特徴**: 
  - サブエージェント実行結果を自動的に記憶
  - 次の処理で前の結果を参照可能
  - JSONシリアライズ不要
  - 自然な会話の流れで情報伝達

### 2. 構造化JSONコンテキスト
- **定義**: 明示的にJSONオブジェクトとして定義されるデータ構造
- **特徴**:
  - JSON.stringify()でシリアライズが必要
  - Taskツールのpromptパラメータで受け渡し
  - 構造化されたフィールド定義

## 結論：適切なコンテキスト処理方式

### ✅ 推奨アプローチ：Claude Codeの自然なコンテキスト機能を活用

```
Layer 2 Agent（自然なコンテキスト保持）
    ↓ 通常のprompt指示
Layer 3 Sub-Agent A 実行 → 結果: "今日は晴れなのだ！"
    ↑ Layer 2が結果を自然に記憶
Layer 2 Agent（前の結果を覚えている状態）
    ↓ prompt: "前に「今日は晴れなのだ！」という挨拶をしました。
              それを踏まえて物語を作ってください"
Layer 3 Sub-Agent B 実行 → 協調的な回答
```

### ❌ 不要なアプローチ：構造化JSONコンテキスト

```javascript
// 不要な複雑さ
context = {
  topic: "今日の天気",
  accumulated_results: ["今日は晴れなのだ！"],
  current_layer: "layer_2"
}

Task({
  subagent_type: "zundamon-storyteller",
  prompt: `コンテキスト: ${JSON.stringify(context)} を使って処理してください`
})
```

## Layer2の「コンテキストハブ」としての役割

### 正しい理解
- **自然な記憶機能**：各サブエージェントの実行結果を記憶
- **適切なプロンプト生成**：前の結果を考慮したプロンプトを作成
- **情報仲介**：サブエージェント間の情報伝達を自然に行う

### 実装例

```xml
<!-- Layer 2 POML -->
<poml>
  <role>ずんだもんキャラクター制御</role>
  
  <task>
    1. zundamon-greeterサブエージェントを呼び出し
    2. その結果を記憶
    3. 前の挨拶内容を踏まえてzundamon-storytellerを呼び出し
    4. 協調的な応答を実現
  </task>
</poml>
```

対応するmarkdownファイルでの実装：
```markdown
## 実行手順

1. zundamon-greeterを呼び出して挨拶を生成
2. 挨拶の結果を確認・記憶
3. 「先ほどの挨拶『{前の結果}』を踏まえて、物語を作成してください」
   というプロンプトでzundamon-storytellerを呼び出し
4. 協調的な物語生成を実現
```

## 設計原則の修正

### 旧方針（過度に複雑）
- JSONオブジェクトによる明示的なコンテキスト管理
- JSON.stringify()による受け渡し
- 構造化されたコンテキストフィールド定義

### 新方針（シンプル・自然）
- Claude Codeの標準機能を活用
- 自然な会話の流れでコンテキスト伝達
- プロンプト設計による情報共有

## 実装への影響

### 不要になったもの
1. **複雑なコンテキストオブジェクト定義**
2. **JSONシリアライズ処理**
3. **accumulated_results等の明示的な状態管理**

### 必要なもの
1. **適切なプロンプト設計**：前の結果を考慮した指示
2. **自然な情報伝達**：会話の流れでコンテキスト共有
3. **Layer2での記憶活用**：実行結果を次の処理に活かす

## メタプロジェクトとしての価値

この明確化により、Claude Code 3層アーキテクチャの**真の価値**が明確になった：

- **シンプルさ**：Claude Codeの標準機能で実現
- **自然さ**：人間の協調作業に近い情報共有
- **実用性**：過度な複雑化を避けた実装

## 参考情報

- 関連文書：[Claude Code サブエージェント動作仕様調査報告](claude-code-subagent-behavior.md)
- 設計仕様：[汎用コンテキスト受け渡し仕様書](../context-passing-specification.md)

---

この明確化により、実装の複雑性を大幅に削減し、Claude Codeの自然な機能を活用した効率的な3層アーキテクチャが実現可能となった。